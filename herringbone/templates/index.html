<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MongoDB Logs Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            padding: 2em;
        }
        h1 {
            color: #ffffff;
        }
        input[type="text"] {
            padding: 10px;
            width: 100%;
            margin-bottom: 1em;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1e1e1e;
        }
        th, td {
            padding: 10px;
            border: 1px solid #333;
            vertical-align: top;
        }
        th {
            background-color: #333;
            color: #f0f0f0;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }
    </style>
    <script>
        let logsCache = [];

        function getValueByPath(obj, path) {
            return path.split('.').reduce((o, p) => o?.[p], obj);
        }

        function filterLogs() {
            const textQuery = document.getElementById("search").value.toLowerCase();
            const jsonQueryStr = document.getElementById("jsonSearch").value.trim();
            let jsonQuery = {};

            try {
                if (jsonQueryStr) {
                    jsonQuery = JSON.parse(jsonQueryStr);
                }
            } catch (e) {
                console.warn("Invalid JSON query");
                return;
            }

            const table = document.querySelector("tbody");
            table.innerHTML = "";

            logsCache.forEach((data, index) => {
                const desc = data.recon_data?.description || '—';
                const addr = data.source_address ? data.source_address[0] + ':' + data.source_address[1] : '—';
                const jsonStr = JSON.stringify(data, null, 2).toLowerCase();

                let textMatch = jsonStr.includes(textQuery);
                let jsonMatch = true;

                for (const [key, val] of Object.entries(jsonQuery)) {
                    const actual = getValueByPath(data, key);
                    if (!actual || !actual.toString().toLowerCase().includes(val.toString().toLowerCase())) {
                        jsonMatch = false;
                        break;
                    }
                }

                if (textMatch && jsonMatch) {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${desc}</td>
                        <td>${addr}</td>
                        <td><pre>${JSON.stringify(data, null, 2)}</pre></td>
                    `;
                    table.appendChild(row);
                }
            });
        }

        async function fetchLogs() {
            try {
                const res = await fetch("/api/logs");
                logsCache = await res.json();
                filterLogs(); // re-apply current filters on update
            } catch (err) {
                console.error("Error fetching logs:", err);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetchLogs();
            setInterval(fetchLogs, 5000); // poll every 5 seconds
        });
    </script>
</head>
<body>
    <h1>MongoDB Logs</h1>
    <input type="text" id="search" placeholder="Search logs..." onkeyup="filterLogs()">
    <input type="text" id="jsonSearch" placeholder='JSON filter (e.g. {"recon_data.description":"System"})' onkeyup="filterLogs()">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Description</th>
                <th>Source Address</th>
                <th>Full JSON</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic rows inserted here -->
        </tbody>
    </table>
</body>
</html>

name: (Ruleset) Build

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'detectionengine/ruleset/**'
      - '.github/workflows/detectionengine-ruleset.yml'

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    # Install dependencies
    steps:
    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/download/v4.43.1/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    - name: Install skopeo
      run: |
        sudo apt-get update
        sudo apt-get install -y skopeo

    # Configure runner with code and docker
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to DockerHub
      uses: docker/login-action@v3
      with:
        registry: quay.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Build, test, and push the Docker image
    - name: Build Docker image
      run: |
        docker build -t quay.io/herringbone/detectionengine-ruleset:latest-${GITHUB_SHA::8}-${{ github.run_number }} ./detectionengine/ruleset

    - name: Run container for smoke test
      run: |
        docker run -d \
        --name test_detectionengine_ruleset \
        quay.io/herringbone/detectionengine-ruleset:latest-${GITHUB_SHA::8}-${{ github.run_number }};
        sleep 1
        docker logs test_detectionengine_ruleset  # Optional: View logs
        docker ps -a               # Show container status
        docker inspect test_detectionengine_ruleset --format='{{.State.Running}}' | grep true

    - name: Push image to DockerHub (only if tests pass)
      run: |
        docker push quay.io/herringbone/detectionengine-ruleset:latest-${GITHUB_SHA::8}-${{ github.run_number }}

    - name: Get image digest
      id: digest
      run: |
        DIGEST=$(skopeo inspect docker://quay.io/herringbone/detectionengine-ruleset:latest-${GITHUB_SHA::8}-${{ github.run_number }} | jq -r '.Digest')
        echo "digest=$DIGEST"
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT

    - name: Update kustomization.yaml with new image digest
      run: |
        TAG="latest-${GITHUB_SHA::8}-${GITHUB_RUN_NUMBER}"
        yq eval -i ".images[0].newTag = \"$TAG\"" kustomize/detectionengine_ruleset/kustomization.yaml
        yq eval -i ".images[0].digest = \"${{ steps.digest.outputs.digest }}\"" kustomize/detectionengine_ruleset/kustomization.yaml

    - name: Detect changes
      id: bump
      run: |
        set -euo pipefail
        if git diff --quiet; then
          echo "changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "changed=true" >> "$GITHUB_OUTPUT"
        fi

    # Create a bot branch with the change and open a PR via GitHub CLI (first-party)
    - name: Create/update PR with gh
      if: steps.bump.outputs.changed == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        BOT_BRANCH="auto/update/detector-digest"
        git config user.name "Herringbone Bot"
        git config user.email "bot@herringbone.dev"

        # Create/refresh bot branch from current main
        git checkout -B "$BOT_BRANCH"
        git add kustomize/detectionengine_detector/kustomization.yaml
        git commit -m "chore(detector): bump image to ${{ steps.digest.outputs.digest }}" --signoff || true
        git push -u origin "$BOT_BRANCH" --force

        # Create PR if none exists; otherwise, it's fine (idempotent)
        if ! gh pr list --head "$BOT_BRANCH" --base main --state open --json number --jq 'length' | grep -q '^0$'; then
          echo "PR already open for $BOT_BRANCH"
        else
          gh pr create \
            --base main \
            --head "$BOT_BRANCH" \
            --title "chore(detector): bump detector image" \
            --body "Automated update to kustomization for detector image.\n- Tag & digest updated by CI\n- This PR respects branch protection."
        fi

    - name: Cleanup
      if: always()
      run: |
        docker rm -f test_detectionengine_detector || true
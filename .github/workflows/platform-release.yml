name: Platform Release

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

          # Install deterministic yq v4 (do NOT use snap)
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Log in to Quay
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Read platform manifest
        id: manifest
        run: |
          VERSION=$(yq '.version' platform/release.yaml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version $VERSION"

      - name: Verify and promote all images
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"

          yq -o=json '.services' platform/release.yaml | \
          jq -r 'to_entries[] | "\(.key) \(.value)"' | \
          while read NAME IMAGE; do
            echo "Releasing $NAME -> $IMAGE"

            cosign verify \
              --certificate-identity-regexp "^https://github.com/herringbonedev/(Herringbone|Herringbone-frontend)/.github/workflows/build-test-push-sign.yml@refs/heads/main$" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              "$IMAGE"

            REF_NO_DIGEST="${IMAGE%@*}"
            BASE="${REF_NO_DIGEST%:*}"

            docker pull "$IMAGE"
            docker tag "$IMAGE" "$BASE:$VERSION"
            docker push "$BASE:$VERSION"
          done

      - name: Prepare docker bundle (rewrite images safely)
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"

          echo "Creating bundle directory"
          rm -rf bundle
          mkdir -p bundle
          cp -r docker bundle/docker

          echo "Rewriting image references to :$VERSION"

          find bundle/docker -type f -name "*.yml" | while read FILE; do
            echo "Processing $FILE"

            yq -i '
              (.services[]?.image |=
                (
                  capture("^(?<repo>[^:@]+)(:(?<tag>[^@]+))?(@sha256:.*)?$")
                  | .repo + ":" + strenv(VERSION)
                )
              )
            ' "$FILE"
          done

          echo "Creating archive"
          ARCHIVE="herringbone-docker-${VERSION}.tar.gz"
          tar -czf "$ARCHIVE" -C bundle/docker .

          echo "ARCHIVE_NAME=$ARCHIVE" >> $GITHUB_ENV
          echo "Archive created: $ARCHIVE"

      - name: Create platform git tag if missing
        run: |
          VERSION="${{ steps.manifest.outputs.version }}"

          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists"
          else
            git tag "$VERSION"
            git push origin "$VERSION"
          fi

      - name: Create GitHub Release and upload docker bundle
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.manifest.outputs.version }}
          name: Platform ${{ steps.manifest.outputs.version }}
          files: ${{ env.ARCHIVE_NAME }}

      - name: Done
        run: |
          echo "Platform release ${{ steps.manifest.outputs.version }} completed"

name: Platform Release

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Log in to Quay
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Read platform manifest
        id: manifest
        run: |
          VERSION=$(yq '.version' platform/release.yaml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify and promote all images
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"

          yq -o=json '.services' platform/release.yaml | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read NAME IMAGE; do
            echo "Releasing $NAME -> $IMAGE"

            echo "Verifying signature..."
            cosign verify \
              --certificate-identity "https://github.com/herringbonedev/Herringbone/.github/workflows/build-test-push-sign.yml@refs/heads/main" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              "$IMAGE"

            BASE="${IMAGE%:*}"

            echo "Pulling $IMAGE"
            docker pull "$IMAGE"

            echo "Tagging $BASE:$VERSION"
            docker tag "$IMAGE" "$BASE:$VERSION"

            echo "Pushing $BASE:$VERSION"
            docker push "$BASE:$VERSION"
          done

      - name: Create platform git tag
        run: |
          VERSION="${{ steps.manifest.outputs.version }}"
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Done
        run: |
          echo "Platform release ${{ steps.manifest.outputs.version }} completed"

name: Platform Release

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo snap install yq

      - name: Log in to Quay
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Read platform manifest
        id: manifest
        run: |
          VERSION=$(yq '.version' platform/release.yaml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify and promote all images
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"

          yq -o=json '.services' platform/release.yaml | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read NAME IMAGE; do
            echo "Releasing $NAME -> $IMAGE"

            cosign verify \
              --certificate-identity-regexp "^https://github.com/herringbonedev/(Herringbone|Herringbone-frontend)/.github/workflows/build-test-push-sign.yml@refs/heads/main$" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              "$IMAGE"

            REF_NO_DIGEST="${IMAGE%@*}"
            BASE="${REF_NO_DIGEST%:*}"

            docker pull "$IMAGE"
            docker tag "$IMAGE" "$BASE:$VERSION"
            docker push "$BASE:$VERSION"
          done
        
      - name: Update docker compose image tags to release version
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"

          find docker -type f -name "*.yml" | while read FILE; do
            echo "Updating $FILE"
            yq -i '
              (.services[]?.image |=
                sub(":[^@]+$"; ":" + strenv(VERSION))
              )
            ' "$FILE"
          done

      - name: Package docker directory
        run: |
          VERSION="${{ steps.manifest.outputs.version }}"
          ARCHIVE="herringbone-docker-${VERSION}.tar.gz"

          tar -czf "$ARCHIVE" -C docker .

          echo "ARCHIVE_NAME=$ARCHIVE" >> $GITHUB_ENV

      - name: Create platform git tag
        run: |
          VERSION="${{ steps.manifest.outputs.version }}"
          git tag "$VERSION"
          git push origin "$VERSION"
      
      - name: Create GitHub Release and upload docker bundle
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.manifest.outputs.version }}
          name: Platform ${{ steps.manifest.outputs.version }}
          files: ${{ env.ARCHIVE_NAME }}

      - name: Done
        run: |
          echo "Platform release ${{ steps.manifest.outputs.version }} completed"

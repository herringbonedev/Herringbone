name: (Receiver) Build, Test, and Push Docker Image

permissions:
  contents: write
  
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'logingestion/receiver/**'
      - '.github/workflows/build-test-push-receiver.yml'

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    steps:
    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/download/v4.43.1/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to DockerHub
      uses: docker/login-action@v3
      with:
        registry: quay.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      run: |
        docker build -t receiver:beta-1.1.0-${{ github.run_number }} ./logingestion/receiver

    - name: Run container for smoke test
      run: |
        docker run -d -p 7002:7002/udp --name test_receiver -e RECEIVER_TYPE=UDP receiver:beta-1.1.0-${{ github.run_number }}
        sleep 5
        docker logs test_receiver  # Optional: View logs
        docker ps -a               # Show container status
        docker inspect test_receiver --format='{{.State.Running}}' | grep true

    - name: UDP Receiver Test
      run: |
        echo "Testing UDP receiver..."
        echo "Test message" | nc -u -w 0 localhost 7002
        sleep 5
        docker logs test_receiver | grep "Test message" || (echo "UDP receiver test failed" && exit 1)

    - name: Push image to DockerHub (only if tests pass)
      run: |
        docker tag receiver:beta-1.1.0-${{ github.run_number }} quay.io/herringbone/receiver:latest
        docker push quay.io/herringbone/receiver:latest

    - name: Get image digest
      id: digest
      run: |
        IMAGE_REF="quay.io/herringbone/receiver:latest"
        DIGEST=$(docker buildx imagetools inspect $IMAGE_REF --format '{{json .}}' | jq -r '.digest')
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      
    - name: Update kustomization.yaml with new image digest
      run: |
        yq e '.images[0].digest = "${{ steps.digest.outputs.digest }}"' -i kustomize/receiver_udp/kustomization.yaml
        yq e '.images[0].digest = "${{ steps.digest.outputs.digest }}"' -i kustomize/receiver_http/kustomization.yaml

    - name: Commit and push kustomization.yaml update
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add kustomize/receiver_http/kustomization.yaml
        git add kustomize/receiver_udp/kustomization.yaml
        git commit -m "Update receiver image digest to ${{ steps.digest.outputs.digest }}"
        git push

    - name: Cleanup
      if: always()
      run: |
        docker stop test_receiver || true
        docker rm test_receiver || true
